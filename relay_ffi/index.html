<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `relay_ffi` crate."><meta name="keywords" content="rust, rustlang, rust-lang, relay_ffi"><title>relay_ffi - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../ayu.css" disabled ><script id="default-settings"></script><script src="../storage.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="icon" type="image/svg+xml" href="../favicon.svg">
<link rel="alternate icon" type="image/png" href="../favicon-16x16.png">
<link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><style type="text/css">#crate-search{background-image:url("../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><a href='../relay_ffi/index.html'><div class='logo-container rust-logo'><img src='../rust-logo.png' alt='logo'></div></a><p class="location">Crate relay_ffi</p><div class="block version"><p>Version 20.10.1</p></div><div class="sidebar-elems"><a id="all-types" href="all.html"><p>See all relay_ffi's items</p></a><div class="block items"><ul><li><a href="#structs">Structs</a></li><li><a href="#functions">Functions</a></li></ul></div><p class="location"></p><script>window.sidebarCurrent = {name: "relay_ffi", ty: "mod", relpath: "../"};</script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu"><img src="../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices" role="menu"></div></div><script src="../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><span class="help-button">?</span>
                <a id="settings-menu" href="../settings.html"><img src="../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../src/relay_ffi/lib.rs.html#1-288" title="goto source code">[src]</a></span><span class="in-band">Crate <a class="mod" href="">relay_ffi</a></span></h1><div class="docblock"><p>Utilities for error handling in FFI bindings.</p>
<p>This crate facilitates an <a href="https://man7.org/linux/man-pages/man3/errno.3.html"><code>errno</code></a>-like error handling pattern: On success, the result of a
function call is returned. On error, a thread-local marker is set that allows to retrieve the
error, message, and a backtrace if available.</p>
<h1 id="catch-errors-and-panics" class="section-header"><a href="#catch-errors-and-panics">Catch Errors and Panics</a></h1>
<p>The <a href="../relay_ffi/attr.catch_unwind.html" title="catch_unwind"><code>catch_unwind</code></a> attribute annotates functions that can internally throw errors. It allows
the use of the questionmark operator <code>?</code> in a function that does not return <code>Result</code>. The error
is then available using <a href="../relay_ffi/fn.with_last_error.html" title="with_last_error"><code>with_last_error</code></a>:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">use</span> <span class="ident">relay_ffi</span>::<span class="ident">catch_unwind</span>;

<span class="attribute">#[<span class="ident">catch_unwind</span>]</span>
<span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">parse_number</span>() <span class="op">-</span><span class="op">&gt;</span> <span class="ident">i32</span> {
    <span class="comment">// use the questionmark operator for errors:</span>
    <span class="kw">let</span> <span class="ident">number</span>: <span class="ident">i32</span> <span class="op">=</span> <span class="string">&quot;42&quot;</span>.<span class="ident">parse</span>()<span class="question-mark">?</span>;

    <span class="comment">// return the value directly, not `Ok`:</span>
    <span class="ident">number</span> <span class="op">*</span> <span class="number">2</span>
}</pre></div>
<h1 id="safety" class="section-header"><a href="#safety">Safety</a></h1>
<p>Since function calls always need to return a value, this crate has to return
<code>std::mem::zeroed()</code> as a placeholder in case of an error. This is unsafe for reference types
and function pointers. Because of this, functions must be marked <code>unsafe</code>.</p>
<p>In most cases, FFI functions should return either <code>repr(C)</code> structs or pointers, in which case
this is safe in principle. The author of the API is responsible for defining the contract,
however, and document the behavior of custom structures in case of an error.</p>
<h1 id="examples" class="section-header"><a href="#examples">Examples</a></h1>
<p>Annotate FFI functions with <a href="../relay_ffi/attr.catch_unwind.html" title="catch_unwind"><code>catch_unwind</code></a> to capture errors. The error can be inspected via
<a href="../relay_ffi/fn.with_last_error.html" title="with_last_error"><code>with_last_error</code></a>:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">use</span> <span class="ident">relay_ffi</span>::{<span class="ident">catch_unwind</span>, <span class="ident">with_last_error</span>};

<span class="attribute">#[<span class="ident">catch_unwind</span>]</span>
<span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">parse_number</span>() <span class="op">-</span><span class="op">&gt;</span> <span class="ident">i32</span> {
    <span class="string">&quot;42&quot;</span>.<span class="ident">parse</span>()<span class="question-mark">?</span>
}

<span class="kw">let</span> <span class="ident">parsed</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">parse_number</span>() };
<span class="kw">match</span> <span class="ident">with_last_error</span>(<span class="op">|</span><span class="ident">e</span><span class="op">|</span> <span class="ident">e</span>.<span class="ident">to_string</span>()) {
    <span class="prelude-val">Some</span>(<span class="ident">error</span>) <span class="op">=</span><span class="op">&gt;</span> <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;errored with: {}&quot;</span>, <span class="ident">error</span>),
    <span class="prelude-val">None</span> <span class="op">=</span><span class="op">&gt;</span> <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;result: {}&quot;</span>, <span class="ident">parsed</span>),
}</pre></div>
<p>To capture panics, register the panic hook early during library initialization:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">use</span> <span class="ident">relay_ffi</span>::{<span class="ident">catch_unwind</span>, <span class="ident">with_last_error</span>};

<span class="ident">relay_ffi</span>::<span class="ident">set_panic_hook</span>();

<span class="attribute">#[<span class="ident">catch_unwind</span>]</span>
<span class="kw">unsafe</span> <span class="kw">fn</span> <span class="ident">fail</span>() {
    <span class="macro">panic</span><span class="macro">!</span>(<span class="string">&quot;expected panic&quot;</span>);
}

<span class="kw">unsafe</span> { <span class="ident">fail</span>() };

<span class="kw">if</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="ident">description</span>) <span class="op">=</span> <span class="ident">with_last_error</span>(<span class="op">|</span><span class="ident">e</span><span class="op">|</span> <span class="ident">e</span>.<span class="ident">to_string</span>()) {
    <span class="macro">println</span><span class="macro">!</span>(<span class="string">&quot;{}&quot;</span>, <span class="ident">description</span>);
}</pre></div>
<h1 id="creating-c-apis" class="section-header"><a href="#creating-c-apis">Creating C-APIs</a></h1>
<p>This is an example for exposing an API to C:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">ffi</span>::<span class="ident">CString</span>;
<span class="kw">use</span> <span class="ident">std</span>::<span class="ident">os</span>::<span class="ident">raw</span>::<span class="ident">c_char</span>;

<span class="attribute">#[<span class="ident">no_mangle</span>]</span>
<span class="kw">pub</span> <span class="kw">unsafe</span> <span class="kw">extern</span> <span class="string">&quot;C&quot;</span> <span class="kw">fn</span> <span class="ident">init_ffi</span>() {
    <span class="ident">relay_ffi</span>::<span class="ident">set_panic_hook</span>();
}

<span class="attribute">#[<span class="ident">no_mangle</span>]</span>
<span class="kw">pub</span> <span class="kw">unsafe</span> <span class="kw">extern</span> <span class="string">&quot;C&quot;</span> <span class="kw">fn</span> <span class="ident">last_strerror</span>() <span class="op">-</span><span class="op">&gt;</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="ident">c_char</span> {
    <span class="kw">let</span> <span class="ident">ptr_opt</span> <span class="op">=</span> <span class="ident">relay_ffi</span>::<span class="ident">with_last_error</span>(<span class="op">|</span><span class="ident">err</span><span class="op">|</span> {
        <span class="ident">CString</span>::<span class="ident">new</span>(<span class="ident">err</span>.<span class="ident">to_string</span>())
            .<span class="ident">unwrap_or_default</span>()
            .<span class="ident">into_raw</span>()
    });

    <span class="ident">ptr_opt</span>.<span class="ident">unwrap_or</span>(<span class="ident">std</span>::<span class="ident">ptr</span>::<span class="ident">null_mut</span>())
}</pre></div>
</div><h2 id="structs" class="section-header"><a href="#structs">Structs</a></h2>
<table><tr class="module-item"><td><a class="struct" href="struct.Panic.html" title="relay_ffi::Panic struct">Panic</a></td><td class="docblock-short"><p>An error representing a panic carrying the message as payload.</p>
</td></tr></table><h2 id="functions" class="section-header"><a href="#functions">Functions</a></h2>
<table><tr class="module-item"><td><a class="fn" href="fn.set_panic_hook.html" title="relay_ffi::set_panic_hook fn">set_panic_hook</a></td><td class="docblock-short"><p>Registers a hook for capturing panics with backtraces.</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.take_last_error.html" title="relay_ffi::take_last_error fn">take_last_error</a></td><td class="docblock-short"><p>Takes the last error, leaving <code>None</code> in its place.</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.with_last_error.html" title="relay_ffi::with_last_error fn">with_last_error</a></td><td class="docblock-short"><p>Acquires a reference to the last error and passes it to the callback, if any.</p>
</td></tr></table><h2 id="attributes" class="section-header"><a href="#attributes">Attribute Macros</a></h2>
<table><tr class="module-item"><td><a class="attr" href="attr.catch_unwind.html" title="relay_ffi::catch_unwind attr">catch_unwind</a></td><td class="docblock-short"><p>Captures errors and panics in a thread-local on <code>unsafe</code> functions.</p>
</td></tr></table></section><section id="search" class="content hidden"></section><section class="footer"></section><script>window.rootPath = "../";window.currentCrate = "relay_ffi";</script><script src="../main.js"></script><script defer src="../search-index.js"></script></body></html>