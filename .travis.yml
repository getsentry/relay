language: python
python: "3.6"

cache:
  directories:
    - cabi/target
    - py/venv
    - $HOME/.cargo
    - $TRAVIS_BUILD_DIR/target
  timeout: 1200

git:
  depth: 1

env:
  global:
    - IMAGE_NAME=getsentry/semaphore
    # DOCKER_USER
    - secure: "G2yD0snSwzlzxOzUXBVJcwo0nGVuTTndaGM+yQKkVGXq/S2OR2xwgyc81GW2u6qky/ISAcaqwE7+MlG7qaAOx2mQawpHgT9J9+teMcjiGIhcg0YFm4ef4Ry55kNbMsPC/FzWcx2qFo9Gfk0WQasM1stjz6Eet/6Zm7RLHLBwzxz+aFCrXwbYqkgyV76AUISuZZDvl325oRmZzi1S7Z/uty/nrAoDSH3qSh1LftTVj9g1kKzirTcDV66aXz3hYK+FmnaWfmin/Z7DWA5+r80M87kFhXE6iOeXx0JEmHb73RwHYzLFzfhQNBFoLtVe01DuNwDtzri/JqAXgLmSCrUZFfkVRZgiBQptOPNqD8lT2JWYVX5pTB1PSpp+GOccizfkQ7JTnVT4CNaNHs00CXEcAkd/jnq6BVYVG26pKwTq6dTp7dzT4wSBfl7VXPXSGAwXkbcNp+15sfNNKkoTwdiLmtPjzGXttAqHMARp832Aj3YxIwD4ar1h2F7W+Hu4WQK1WD1qf6yl0T0mqBnH2xnbgKzp1akEQhGOvCoH6ySEUPPoQ5M6enZTetcV5EdtQrXrBwMun+O5IyxTzpYegKv8n1aRlNysqapYD3Z/e58OwepnGKsOv08Ru9oO8/BqgcyDipsj4BO8s0iOU6b3KcSJp6eFNdNszme6JftTzV3jItM="
    # DOCKER_PASS
    - secure: "tCGrHd3ZQ6lW/EfqYUXuEkvRAgTwsvk7Dv6qiPlR2AES4UkwIIhF6bqpya5bWORLhYK7wI+PsLp294cxPQNrNmZr6H6HrqLXK5gfBF6h1rAFcInMjBVmflWCg54bAUz/yzPHX7X60GgRhRAxOEcoemP8+wPmM5pw3ebLs3ajbXT8KXHspwCTY1aKCehr/tCgbx5BjZyfu8O1Rxk8c88Hv/jUi/McyLNbXYcFMPTQ2CFOlZp4C1E6F5si/bDwi8dDY5k13VbXtQq5s2Lx/wqhezmZbcxtIafHtE3INfTD7nfwOppkoTzGdIcdfp0i5fEAFPOg+sPc72VYrt2078IRajhsxUBNebvYebZ8iutV3YfV9oGnV80QFsQFkrVucuOxnoVYtLlGS2RSGO9li3XvR6+eGimgCu5RoglZrPrbJa4wGyu8L7ePc4Kaaxm8LxV3j+CUcgLLSCDgNN4XcmvgrR4XB8xACk8xW6Kq9f3TelP8Gbq/HTF3xiJ8NR9lxUp7K1juTbQ9zRmRdc+kvrfhjVQDQkG1PYrICQBhnBJt13IHea+imtUAk7i2p31BZcgnJaALPPBSCyWBw9wVZWq6Q7Jm/odr7aiUKmvzJKTVkr5oTr0UHheI4myEPrqYdCq17hJEJxOf/iyxMglHli5UHCWkuskvDCWskXUnQVE7ams="

branches:
  only:
    - master
    - /^release\/[\d.]+$/

before_install:
  - curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain ${RUST_TOOLCHAIN:-stable}
  - export PATH=~/.cargo/bin/:$PATH

install: skip

before_cache:
  - make clean-target-dir

matrix:
  fast_finish: true
  include:
    # -------------------------------------
    # STATIC ANALYSIS
    # -------------------------------------

    - name: "check: codestyle"
      script: make -e style

    - name: "check: lint"
      script: make -e lint

    # -------------------------------------
    # RUST TESTS
    # -------------------------------------

    - name: "test: semaphore[linux]"
      os: linux
      sudo: required
      addons:
        apt:
          packages:
            - libssl-dev
            - libgeoip-dev
      install:
        - cargo tarpaulin --version || cargo install --force cargo-tarpaulin
      script:
        - make -e test-coverage

    - name: "test: semaphore[macos]"
      os: osx
      language: generic
      install: cargo build --all
      script: make -e test-rust

    # -------------------------------------
    # PYTHON LIBRARY TESTS
    # -------------------------------------

    - name: "test: libsemaphore"
      os: linux
      script: make -e test-python

    # -------------------------------------
    # EXECUTALE INTEGRATION TESTS
    # -------------------------------------

    - name: "integration-test: semaphore"
      os: linux
      # https://github.com/travis-ci/travis-ci/issues/9831
      sudo: true
      install:
        - export PATH=$PATH:$HOME/.cargo/bin
        - wget https://github.com/yyyar/gobetween/releases/download/0.6.0/gobetween_0.6.0_linux_amd64.tar.gz -O - | tar xz; mv gobetween $HOME/.cargo/bin
        - sudo add-apt-repository ppa:vbernat/haproxy-1.8 -y
        - sudo apt-get update
        - sudo apt-get install haproxy -y
      script:
        - make -e test-integration

    # -------------------------------------
    # RUST RELEASE BUILDS
    # -------------------------------------

    - name: "release: semaphore[linux]"
      os: linux
      language: generic
      services:
        - docker
      env:
        - BUILD_ARCH=x86_64
      script:
        - make -e docker
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/octet-stream" -n semaphore-Linux-x86_64 target/x86_64-unknown-linux-gnu/release/semaphore  || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zip semaphore-debug.zip target/x86_64-unknown-linux-gnu/release/semaphore.debug
        - zeus upload -t "application/octet-stream" -n semaphore-Linux-x86_64-debug.zip semaphore-debug.zip  || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        # Build and push image to Dockerhub, on master branch only
        - bash scripts/push-docker-image.sh

    # - os: linux
    #   language: generic
    #   env:
    #     - BUILD_ARCH=i686
    #   script:
    #     - make -e releasebuild-docker
    #     - npm install -g @zeus-ci/cli
    #     - zeus upload -t "application/octet-stream"
    #                   -n semaphore-Linux-i686
    #                   target/i686-unknown-linux-gnu/release/semaphore

    - name: "release: semaphore[macos]"
      os: osx
      language: generic
      script:
        - make -e release
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/octet-stream" -n semaphore-Darwin-x86_64 target/release/semaphore || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zip -r semaphore-dsym.zip target/release/semaphore.dSYM
        - zeus upload -t "application/octet-stream" -n semaphore-Darwin-x86_64-dsym.zip semaphore-dsym.zip || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]

    # -------------------------------------
    # PYTHON RELEASE BUILDS
    # -------------------------------------

    - name: "release: libsemaphore[linux-x86]"
      os: linux
      sudo: required
      env: BUILD_ARCH=i686
      language: generic
      script:
        - make -e wheel-manylinux
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/zip+wheel" py/dist/* || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]

    - name: "release: libsemaphore[linux-x86_64]"
      sudo: required
      env: BUILD_ARCH=x86_64
      language: generic
      script:
        - make -e wheel-manylinux
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/zip+wheel" py/dist/* || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]

    - name: "release: libsemaphore[macos]"
      os: osx
      language: generic
      osx_image: xcode7.3
      env: SEMAPHORE_PYTHON_VERSION=python
      script:
        - make -e wheel
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/zip+wheel" py/dist/* || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]

    - name: "release: libsemaphore[sdist]"
      os: linux
      sudo: required
      language: generic
      script:
        - make -e sdist
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/zip+wheel" py/dist/* || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]

notifications:
  webhooks:
    urls:
      - https://zeus.ci/hooks/a3901574-fbb7-11e7-9451-0a580a280114/public/provider/travis/webhook
    on_success: always
    on_failure: always
    on_start: always
    on_cancel: always
    on_error: always
