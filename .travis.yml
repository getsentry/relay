language: python
python: "3.7"
os: linux

git:
  depth: 1

branches:
  only:
    - master
    - /^release\/[\d.]+$/
    - /^release-library\/[\d.]+$/

before_install:
  - curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain ${RUST_TOOLCHAIN:-stable}
  - export PATH=~/.cargo/bin/:$PATH
  - '[ "$TRAVIS_BRANCH" != "master" ] || export PYTEST_SENTRY_ALWAYS_REPORT=1'

install: skip

before_cache:
  - make clean-target-dir

jobs:
  fast_finish: true
  include:
    # -------------------------------------
    # RUST RELEASE BUILDS
    # -------------------------------------

    - name: "release: relay[linux]"
      if: branch ~= /^release\/[\d.]+$/
      language: generic
      before_install: skip
      services:
        - docker
      env:
        - BUILD_ARCH=x86_64
      script:
        - make -e docker
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/octet-stream" -n relay-Linux-x86_64 target/x86_64-unknown-linux-gnu/release/relay  || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zip relay-debug.zip target/x86_64-unknown-linux-gnu/release/relay.debug
        - zeus upload -t "application/octet-stream" -n relay-Linux-x86_64-debug.zip relay-debug.zip  || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]

    - name: "release: relay[macos]"
      if: branch ~= /^release\/[\d.]+$/
      os: osx
      language: generic
      script:
        - make -e release
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/octet-stream" -n relay-Darwin-x86_64 target/release/relay || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zip -r relay-dsym.zip target/release/relay.dSYM
        - zeus upload -t "application/octet-stream" -n relay-Darwin-x86_64-dsym.zip relay-dsym.zip || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]

    # -------------------------------------
    # PYTHON RELEASE BUILDS
    # -------------------------------------

    - name: "release: librelay[linux-x86]"
      if: branch ~= /^release-library\/[\d.]+$/
      env: BUILD_ARCH=i686
      language: generic
      script:
        - make -e wheel-manylinux
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/zip+wheel" py/dist/* || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]

    - name: "release: librelay[linux-x86_64]"
      if: branch ~= /^release-library\/[\d.]+$/
      env: BUILD_ARCH=x86_64
      language: generic
      script:
        - make -e wheel-manylinux
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/zip+wheel" py/dist/* || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]

    - name: "release: librelay[macos]"
      if: branch ~= /^release-library\/[\d.]+$/
      os: osx
      language: generic
      osx_image: xcode9.4
      env: RELAY_PYTHON_VERSION=python
      script:
        - make -e wheel
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/zip+wheel" py/dist/* || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]

    - name: "release: librelay[sdist]"
      if: branch ~= /^release-library\/[\d.]+$/
      script:
        - make -e sdist
        - npm install -g @zeus-ci/cli || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]
        - zeus upload -t "application/zip+wheel" py/dist/* || [[ ! "$TRAVIS_BRANCH" =~ ^release/ ]]

notifications:
  webhooks:
    urls:
      - https://zeus.ci/hooks/a3901574-fbb7-11e7-9451-0a580a280114/public/provider/travis/webhook
    on_success: always
    on_failure: always
    on_start: always
    on_cancel: always
    on_error: always
