<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Metric protocol, aggregation and processing for Sentry."><title>relay_metrics - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-cb6f1f67f1bcd037.css" id="mainThemeStyle"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="relay_metrics" data-themes="" data-resource-suffix="" data-rustdoc-version="1.73.0 (cc66ad468 2023-10-03)" data-channel="1.73.0" data-search-js="search-6dfdfced5eff6596.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-1596385f77d47ef2.css" data-theme-dark-css="dark-0a43001d3fc2282c.css" data-theme-ayu-css="ayu-fd19013d6ce078bf.css" ><script src="../static.files/storage-db41da1a38ea3cb8.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-0795b7d26be81095.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../static.files/light-1596385f77d47ef2.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../static.files/dark-0a43001d3fc2282c.css"><link rel="stylesheet" href="../static.files/noscript-cffde32267a19fd6.css"></noscript><link rel="icon" href="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../relay_metrics/index.html"><img src="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../relay_metrics/index.html"><img src="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png" alt="logo"></a><h2 class="location"><a href="#">Crate relay_metrics</a></h2><div class="sidebar-elems"><ul class="block"><li class="version">Version 23.10.1</li><li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#macros">Macros</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#types">Type Definitions</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Crate <a class="mod" href="#">relay_metrics</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../src/relay_metrics/lib.rs.html#1-83">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Metric protocol, aggregation and processing for Sentry.</p>
<p>Metrics are high-volume values sent from Sentry clients, integrations, or extracted from errors
and transactions, that can be aggregated and queried over large time windows. As opposed to rich
errors and transactions, metrics carry relatively little context information in tags with low
cardinality.</p>
<h2 id="protocol"><a href="#protocol">Protocol</a></h2>
<p>Clients submit metrics in a <a href="struct.Bucket.html" title="struct relay_metrics::Bucket">text-based protocol</a> based on StatsD. See the <a href="struct.Bucket.html#fields" title="struct relay_metrics::Bucket">field
documentation</a> on <code>Bucket</code> for more information on the components. A sample
submission looks like this:</p>
<div class="example-wrap"><pre class="language-text"><code>endpoint.response_time@millisecond:36:49:57:68|d|#route:user_index|T1615889440
endpoint.hits:4|c|#route:user_index|T1615889440
endpoint.parallel_requests:25:17:42:220:85|g|#route:user_index|T1615889440
endpoint.users:3182887624:4267882815|s|#route:user_index|T1615889440
</code></pre></div>
<p>The metric type is part of its signature just like the unit. Therefore, it is allowed to reuse a
metric name for multiple metric types, which will result in multiple metrics being recorded.</p>
<h2 id="metric-envelopes"><a href="#metric-envelopes">Metric Envelopes</a></h2>
<p>To send one or more metrics to Relay, the raw protocol is enclosed in an envelope item of type
<code>metrics</code>:</p>
<div class="example-wrap"><pre class="language-text"><code>{}
{&quot;type&quot;: &quot;statsd&quot;, ...}
endpoint.response_time@millisecond:36:49:57:68|d|#route:user_index|T1615889440
endpoint.hits:4|c|#route:user_index|T1615889440
endpoint.parallel_requests:25:17:42:220:85|g|#route:user_index|T1615889440
endpoint.users:3182887624:4267882815|s|#route:user_index|T1615889440
...
</code></pre></div>
<p>Note that the name format used in the statsd protocol is different from the MRI: Metric names
are not prefixed with <code>&lt;ty&gt;:</code> as the type is somewhere else in the protocol. If no metric
namespace is specified, the <code>&quot;custom&quot;</code> namespace is assumed.</p>
<p>Optionally, a timestamp can be added to every line of the submitted envelope. The timestamp has
to be a valid Unix timestamp (UTC) and must be prefixed with <code>T</code>. If it is omitted, the
<code>received</code> time of the envelope is assumed.</p>
<h2 id="aggregation"><a href="#aggregation">Aggregation</a></h2>
<p>Relay accumulates all metrics in <a href="struct.Bucket.html" title="struct relay_metrics::Bucket">time buckets</a> before sending them onwards. Aggregation
is handled by the <a href="enum.Aggregator.html" title="enum relay_metrics::Aggregator"><code>Aggregator</code></a>, which should be created once for the entire system. It flushes
aggregates in regular intervals, either shortly after their original time window has passed or
with a debounce delay for backdated submissions.</p>
<p><strong>Warning</strong>: With chained Relays submission delays accumulate.</p>
<p>Aggregate buckets are encoded in JSON with the following schema:</p>
<div class="example-wrap"><pre class="language-json"><code>[
  {
    &quot;timestamp&quot;: 1615889440,
    &quot;width&quot;: 0,
    &quot;name&quot;: &quot;d:custom/endpoint.response_time@millisecond&quot;,
    &quot;type&quot;: &quot;d&quot;,
    &quot;value&quot;: [
      36.0,
      49.0,
      57.0,
      68.0
    ],
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  },
  {
    &quot;timestamp&quot;: 1615889440,
    &quot;width&quot;: 0,
    &quot;name&quot;: &quot;c:custom/endpoint.hits@none&quot;,
    &quot;type&quot;: &quot;c&quot;,
    &quot;value&quot;: 4.0,
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  },
  {
    &quot;timestamp&quot;: 1615889440,
    &quot;width&quot;: 0,
    &quot;name&quot;: &quot;g:custom/endpoint.parallel_requests@none&quot;,
    &quot;type&quot;: &quot;g&quot;,
    &quot;value&quot;: {
      &quot;last&quot;: 25.0,
      &quot;min&quot;: 17.0,
      &quot;max&quot;: 42.0,
      &quot;sum&quot;: 220.0,
      &quot;count&quot;: 85
    },
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  },
  {
    &quot;timestamp&quot;: 1615889440,
    &quot;width&quot;: 0,
    &quot;name&quot;: &quot;s:custom/endpoint.users@none&quot;,
    &quot;type&quot;: &quot;s&quot;,
    &quot;value&quot;: [
      3182887624,
      4267882815
    ],
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  }
]
</code></pre></div><h2 id="ingestion"><a href="#ingestion">Ingestion</a></h2>
<p>Processing Relays write aggregate buckets into the ingestion Kafka stream. The schema is similar
to the aggregation payload, with the addition of scoping information. Each bucket is sent in a
separate message:</p>
<div class="example-wrap"><pre class="language-json"><code>{
  &quot;org_id&quot;: 1,
  &quot;project_id&quot;: 42,
  &quot;name&quot;: &quot;endpoint.response_time&quot;,
  &quot;unit&quot;: &quot;millisecond&quot;,
  &quot;value&quot;: [
    36.0,
    49.0,
    57.0,
    68.0
  ],
  &quot;type&quot;: &quot;d&quot;,
  &quot;timestamp&quot;: 1615889440,
  &quot;tags&quot;: {
    &quot;route&quot;: &quot;user_index&quot;
  }
}
</code></pre></div></div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="aggregator/index.html" title="mod relay_metrics::aggregator">aggregator</a></div><div class="desc docblock-short">Only public for benchmarks.</div></li></ul><h2 id="macros" class="small-section-header"><a href="#macros">Macros</a></h2><ul class="item-table"><li><div class="item-name"><a class="macro" href="macro.dist.html" title="macro relay_metrics::dist">dist</a></div><div class="desc docblock-short">Creates a <a href="type.DistributionValue.html" title="type relay_metrics::DistributionValue"><code>DistributionValue</code></a> containing the given arguments.</div></li></ul><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.AcceptsMetrics.html" title="struct relay_metrics::AcceptsMetrics">AcceptsMetrics</a></div><div class="desc docblock-short">Check whether the aggregator has not (yet) exceeded its total limits. Used for health checks.</div></li><li><div class="item-name"><a class="struct" href="struct.AggregatorService.html" title="struct relay_metrics::AggregatorService">AggregatorService</a></div><div class="desc docblock-short">A service for aggregationg metric buckets.</div></li><li><div class="item-name"><a class="struct" href="struct.AggregatorServiceConfig.html" title="struct relay_metrics::AggregatorServiceConfig">AggregatorServiceConfig</a></div><div class="desc docblock-short">Parameters used by the <a href="struct.AggregatorService.html" title="struct relay_metrics::AggregatorService"><code>AggregatorService</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.Bucket.html" title="struct relay_metrics::Bucket">Bucket</a></div><div class="desc docblock-short">An aggregation of metric values.</div></li><li><div class="item-name"><a class="struct" href="struct.CustomUnit.html" title="struct relay_metrics::CustomUnit">CustomUnit</a></div><div class="desc docblock-short">Custom user-defined units without builtin conversion.</div></li><li><div class="item-name"><a class="struct" href="struct.FlushBuckets.html" title="struct relay_metrics::FlushBuckets">FlushBuckets</a></div><div class="desc docblock-short">A message containing a vector of buckets to be flushed.</div></li><li><div class="item-name"><a class="struct" href="struct.GaugeValue.html" title="struct relay_metrics::GaugeValue">GaugeValue</a></div><div class="desc docblock-short">A snapshot of values within a <a href="struct.Bucket.html" title="struct relay_metrics::Bucket"><code>Bucket</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.MergeBuckets.html" title="struct relay_metrics::MergeBuckets">MergeBuckets</a></div><div class="desc docblock-short">A message containing a list of <a href="struct.Bucket.html" title="struct relay_metrics::Bucket"><code>Bucket</code></a>s to be inserted into the aggregator.</div></li><li><div class="item-name"><a class="struct" href="struct.MetricResourceIdentifier.html" title="struct relay_metrics::MetricResourceIdentifier">MetricResourceIdentifier</a></div><div class="desc docblock-short">A unique identifier for metrics including typing and namespacing.</div></li><li><div class="item-name"><a class="struct" href="struct.ParseBuckets.html" title="struct relay_metrics::ParseBuckets">ParseBuckets</a></div><div class="desc docblock-short">Iterator over parsed metrics returned from <a href="struct.Bucket.html#method.parse_all" title="associated function relay_metrics::Bucket::parse_all"><code>Bucket::parse_all</code></a>.</div></li><li><div class="item-name"><a class="struct" href="struct.ParseMetricError.html" title="struct relay_metrics::ParseMetricError">ParseMetricError</a></div><div class="desc docblock-short">An error returned when metrics or MRIs cannot be parsed.</div></li><li><div class="item-name"><a class="struct" href="struct.ParseMetricUnitError.html" title="struct relay_metrics::ParseMetricUnitError">ParseMetricUnitError</a></div><div class="desc docblock-short">An error parsing a <a href="enum.MetricUnit.html" title="enum relay_metrics::MetricUnit"><code>MetricUnit</code></a> or one of its variants.</div></li><li><div class="item-name"><a class="struct" href="struct.RouterService.html" title="struct relay_metrics::RouterService">RouterService</a></div><div class="desc docblock-short">Service that routes metrics &amp; metric buckets to the appropriate aggregator.</div></li><li><div class="item-name"><a class="struct" href="struct.ScopedAggregatorConfig.html" title="struct relay_metrics::ScopedAggregatorConfig">ScopedAggregatorConfig</a></div><div class="desc docblock-short">Contains an <a href="struct.AggregatorServiceConfig.html" title="struct relay_metrics::AggregatorServiceConfig"><code>AggregatorServiceConfig</code></a> for a specific scope.</div></li><li><div class="item-name"><a class="struct" href="struct.UnixTimestamp.html" title="struct relay_metrics::UnixTimestamp">UnixTimestamp</a></div><div class="desc docblock-short">A unix timestamp (full seconds elapsed since 1970-01-01 00:00 UTC).</div></li></ul><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.Aggregator.html" title="enum relay_metrics::Aggregator">Aggregator</a></div><div class="desc docblock-short">Aggregator service interface.</div></li><li><div class="item-name"><a class="enum" href="enum.BucketValue.html" title="enum relay_metrics::BucketValue">BucketValue</a></div><div class="desc docblock-short">The <a href="struct.Bucket.html#structfield.value" title="field relay_metrics::Bucket::value">aggregated value</a> of a metric bucket.</div></li><li><div class="item-name"><a class="enum" href="enum.Condition.html" title="enum relay_metrics::Condition">Condition</a></div><div class="desc docblock-short">Condition that needs to be met for a metric or bucket to be routed to a
secondary aggregator.</div></li><li><div class="item-name"><a class="enum" href="enum.DurationUnit.html" title="enum relay_metrics::DurationUnit">DurationUnit</a></div><div class="desc docblock-short">Time duration units used in <a href="enum.MetricUnit.html#variant.Duration" title="variant relay_metrics::MetricUnit::Duration"><code>MetricUnit::Duration</code></a>.</div></li><li><div class="item-name"><a class="enum" href="enum.Field.html" title="enum relay_metrics::Field">Field</a></div><div class="desc docblock-short">Defines a field and a field value to compare to when a <a href="enum.Condition.html" title="enum relay_metrics::Condition"><code>Condition</code></a> is evaluated.</div></li><li><div class="item-name"><a class="enum" href="enum.FractionUnit.html" title="enum relay_metrics::FractionUnit">FractionUnit</a></div><div class="desc docblock-short">Units of fraction used in <a href="enum.MetricUnit.html#variant.Fraction" title="variant relay_metrics::MetricUnit::Fraction"><code>MetricUnit::Fraction</code></a>.</div></li><li><div class="item-name"><a class="enum" href="enum.InformationUnit.html" title="enum relay_metrics::InformationUnit">InformationUnit</a></div><div class="desc docblock-short">Size of information derived from bytes, used in <a href="enum.MetricUnit.html#variant.Information" title="variant relay_metrics::MetricUnit::Information"><code>MetricUnit::Information</code></a>.</div></li><li><div class="item-name"><a class="enum" href="enum.MetricNamespace.html" title="enum relay_metrics::MetricNamespace">MetricNamespace</a></div><div class="desc docblock-short">The namespace of a metric.</div></li><li><div class="item-name"><a class="enum" href="enum.MetricType.html" title="enum relay_metrics::MetricType">MetricType</a></div><div class="desc docblock-short">The type of a <a href="enum.BucketValue.html" title="enum relay_metrics::BucketValue"><code>BucketValue</code></a>, determining its aggregation and evaluation.</div></li><li><div class="item-name"><a class="enum" href="enum.MetricUnit.html" title="enum relay_metrics::MetricUnit">MetricUnit</a></div><div class="desc docblock-short">The unit of measurement of a metric value.</div></li></ul><h2 id="types" class="small-section-header"><a href="#types">Type Definitions</a></h2><ul class="item-table"><li><div class="item-name"><a class="type" href="type.CounterType.html" title="type relay_metrics::CounterType">CounterType</a></div><div class="desc docblock-short">Type used for Counter metric</div></li><li><div class="item-name"><a class="type" href="type.DistributionType.html" title="type relay_metrics::DistributionType">DistributionType</a></div><div class="desc docblock-short">Type of distribution entries</div></li><li><div class="item-name"><a class="type" href="type.DistributionValue.html" title="type relay_metrics::DistributionValue">DistributionValue</a></div><div class="desc docblock-short">A distribution of values within a <a href="struct.Bucket.html" title="struct relay_metrics::Bucket"><code>Bucket</code></a>.</div></li><li><div class="item-name"><a class="type" href="type.GaugeType.html" title="type relay_metrics::GaugeType">GaugeType</a></div><div class="desc docblock-short">Type used for Gauge entries</div></li><li><div class="item-name"><a class="type" href="type.SetType.html" title="type relay_metrics::SetType">SetType</a></div><div class="desc docblock-short">Type used for set elements in Set metric</div></li><li><div class="item-name"><a class="type" href="type.SetValue.html" title="type relay_metrics::SetValue">SetValue</a></div><div class="desc docblock-short">A set of unique values.</div></li></ul></section></div></main></body></html>