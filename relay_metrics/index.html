<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Metric protocol, aggregation and processing for Sentry."><title>relay_metrics - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-84e720fa.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="relay_metrics" data-themes="" data-resource-suffix="" data-rustdoc-version="1.89.0 (29483883e 2025-08-04)" data-channel="1.89.0" data-search-js="search-92309212.js" data-settings-js="settings-5514c975.js" ><script src="../static.files/storage-4e99c027.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-fd3af306.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-32bb7600.css"></noscript><link rel="icon" href="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button><a class="logo-container" href="../relay_metrics/index.html"><img src="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png" alt=""></a></nav><nav class="sidebar"><div class="sidebar-crate"><a class="logo-container" href="../relay_metrics/index.html"><img src="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png" alt="logo"></a><h2><a href="../relay_metrics/index.html">relay_<wbr>metrics</a><span class="version">25.8.0</span></h2></div><div class="sidebar-elems"><ul class="block"><li><a id="all-types" href="all.html">All Items</a></li></ul><section id="rustdoc-toc"><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#protocol" title="Protocol">Protocol</a></li><li><a href="#metric-envelopes" title="Metric Envelopes">Metric Envelopes</a></li><li><a href="#aggregation" title="Aggregation">Aggregation</a></li><li><a href="#ingestion" title="Ingestion">Ingestion</a></li></ul><h3><a href="#modules">Crate Items</a></h3><ul class="block"><li><a href="#modules" title="Modules">Modules</a></li><li><a href="#macros" title="Macros">Macros</a></li><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#enums" title="Enums">Enums</a></li><li><a href="#functions" title="Functions">Functions</a></li><li><a href="#types" title="Type Aliases">Type Aliases</a></li></ul></section><div id="rustdoc-modnav"></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Crate <span>relay_metrics</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../src/relay_metrics/lib.rs.html#1-83">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Metric protocol, aggregation and processing for Sentry.</p>
<p>Metrics are high-volume values sent from Sentry clients, integrations, or extracted from errors
and transactions, that can be aggregated and queried over large time windows. As opposed to rich
errors and transactions, metrics carry relatively little context information in tags with low
cardinality.</p>
<h2 id="protocol"><a class="doc-anchor" href="#protocol">§</a>Protocol</h2>
<p>Clients submit metrics in a <a href="struct.Bucket.html" title="struct relay_metrics::Bucket">text-based protocol</a> based on StatsD. See the <a href="struct.Bucket.html#fields" title="struct relay_metrics::Bucket">field
documentation</a> on <code>Bucket</code> for more information on the components. A sample
submission looks like this:</p>
<div class="example-wrap"><pre class="language-text"><code>endpoint.response_time@millisecond:36:49:57:68|d|#route:user_index|T1615889440
endpoint.hits:4|c|#route:user_index|T1615889440
endpoint.parallel_requests:25:17:42:220:85|g|#route:user_index|T1615889440
endpoint.users:3182887624:4267882815|s|#route:user_index|T1615889440</code></pre></div>
<p>The metric type is part of its signature just like the unit. Therefore, it is allowed to reuse a
metric name for multiple metric types, which will result in multiple metrics being recorded.</p>
<h2 id="metric-envelopes"><a class="doc-anchor" href="#metric-envelopes">§</a>Metric Envelopes</h2>
<p>To send one or more metrics to Relay, the raw protocol is enclosed in an envelope item of type
<code>metrics</code>:</p>
<div class="example-wrap"><pre class="language-text"><code>{}
{&quot;type&quot;: &quot;statsd&quot;, ...}
endpoint.response_time@millisecond:36:49:57:68|d|#route:user_index|T1615889440
endpoint.hits:4|c|#route:user_index|T1615889440
endpoint.parallel_requests:25:17:42:220:85|g|#route:user_index|T1615889440
endpoint.users:3182887624:4267882815|s|#route:user_index|T1615889440
...</code></pre></div>
<p>Note that the name format used in the statsd protocol is different from the MRI: Metric names
are not prefixed with <code>&lt;ty&gt;:</code> as the type is somewhere else in the protocol. If no metric
namespace is specified, the <code>"custom"</code> namespace is assumed.</p>
<p>Optionally, a timestamp can be added to every line of the submitted envelope. The timestamp has
to be a valid Unix timestamp (UTC) and must be prefixed with <code>T</code>. If it is omitted, the
<code>received</code> time of the envelope is assumed.</p>
<h2 id="aggregation"><a class="doc-anchor" href="#aggregation">§</a>Aggregation</h2>
<p>Relay accumulates all metrics in <a href="struct.Bucket.html" title="struct relay_metrics::Bucket">time buckets</a> before sending them onwards. Aggregation
is handled by the <a href="aggregator/struct.Aggregator.html" title="struct relay_metrics::aggregator::Aggregator"><code>aggregator::Aggregator</code></a>, which should be created once for the entire system. It flushes
aggregates in regular intervals, either shortly after their original time window has passed or
with a debounce delay for backdated submissions.</p>
<p><strong>Warning</strong>: With chained Relays submission delays accumulate.</p>
<p>Aggregate buckets are encoded in JSON with the following schema:</p>
<div class="example-wrap"><pre class="language-json"><code>[
  {
    &quot;timestamp&quot;: 1615889440,
    &quot;width&quot;: 0,
    &quot;name&quot;: &quot;d:custom/endpoint.response_time@millisecond&quot;,
    &quot;type&quot;: &quot;d&quot;,
    &quot;value&quot;: [
      36.0,
      49.0,
      57.0,
      68.0
    ],
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  },
  {
    &quot;timestamp&quot;: 1615889440,
    &quot;width&quot;: 0,
    &quot;name&quot;: &quot;c:custom/endpoint.hits@none&quot;,
    &quot;type&quot;: &quot;c&quot;,
    &quot;value&quot;: 4.0,
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  },
  {
    &quot;timestamp&quot;: 1615889440,
    &quot;width&quot;: 0,
    &quot;name&quot;: &quot;g:custom/endpoint.parallel_requests@none&quot;,
    &quot;type&quot;: &quot;g&quot;,
    &quot;value&quot;: {
      &quot;last&quot;: 25.0,
      &quot;min&quot;: 17.0,
      &quot;max&quot;: 42.0,
      &quot;sum&quot;: 220.0,
      &quot;count&quot;: 85
    },
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  },
  {
    &quot;timestamp&quot;: 1615889440,
    &quot;width&quot;: 0,
    &quot;name&quot;: &quot;s:custom/endpoint.users@none&quot;,
    &quot;type&quot;: &quot;s&quot;,
    &quot;value&quot;: [
      3182887624,
      4267882815
    ],
    &quot;tags&quot;: {
      &quot;route&quot;: &quot;user_index&quot;
    }
  }
]</code></pre></div><h2 id="ingestion"><a class="doc-anchor" href="#ingestion">§</a>Ingestion</h2>
<p>Processing Relays write aggregate buckets into the ingestion Kafka stream. The schema is similar
to the aggregation payload, with the addition of scoping information. Each bucket is sent in a
separate message:</p>
<div class="example-wrap"><pre class="language-json"><code>{
  &quot;org_id&quot;: 1,
  &quot;project_id&quot;: 42,
  &quot;name&quot;: &quot;endpoint.response_time&quot;,
  &quot;unit&quot;: &quot;millisecond&quot;,
  &quot;value&quot;: [
    36.0,
    49.0,
    57.0,
    68.0
  ],
  &quot;type&quot;: &quot;d&quot;,
  &quot;timestamp&quot;: 1615889440,
  &quot;tags&quot;: {
    &quot;route&quot;: &quot;user_index&quot;
  }
}</code></pre></div></div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><dl class="item-table"><dt><a class="mod" href="aggregator/index.html" title="mod relay_metrics::aggregator">aggregator</a></dt><dd>Core functionality of metrics aggregation.</dd><dt><a class="mod" href="cogs/index.html" title="mod relay_metrics::cogs">cogs</a></dt><dd>COGS related metric utilities.</dd></dl><h2 id="macros" class="section-header">Macros<a href="#macros" class="anchor">§</a></h2><dl class="item-table"><dt><a class="macro" href="macro.dist.html" title="macro relay_metrics::dist">dist</a></dt><dd>Creates a <a href="type.DistributionValue.html" title="type relay_metrics::DistributionValue"><code>DistributionValue</code></a> containing the given arguments.</dd></dl><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><dl class="item-table"><dt><a class="struct" href="struct.Bucket.html" title="struct relay_metrics::Bucket">Bucket</a></dt><dd>An aggregation of metric values.</dd><dt><a class="struct" href="struct.BucketMetadata.html" title="struct relay_metrics::BucketMetadata">Bucket<wbr>Metadata</a></dt><dd>Relay internal metadata for a metric bucket.</dd><dt><a class="struct" href="struct.BucketView.html" title="struct relay_metrics::BucketView">Bucket<wbr>View</a></dt><dd>A view into a metrics bucket. Sometimes also called a partial bucket.
A view contains a subset of datapoints of the original bucket.</dd><dt><a class="struct" href="struct.BucketsView.html" title="struct relay_metrics::BucketsView">Buckets<wbr>View</a></dt><dd>A view into a slice of metric buckets.</dd><dt><a class="struct" href="struct.BucketsViewBySizeIter.html" title="struct relay_metrics::BucketsViewBySizeIter">Buckets<wbr>View<wbr>BySize<wbr>Iter</a></dt><dd>Iterator slicing a <a href="struct.BucketsView.html" title="struct relay_metrics::BucketsView"><code>BucketsView</code></a> into smaller views constrained by a given size in bytes.</dd><dt><a class="struct" href="struct.BucketsViewIter.html" title="struct relay_metrics::BucketsViewIter">Buckets<wbr>View<wbr>Iter</a></dt><dd>Iterator yielding all items contained in a <a href="struct.BucketsView.html" title="struct relay_metrics::BucketsView"><code>BucketsView</code></a>.</dd><dt><a class="struct" href="struct.ByNamespace.html" title="struct relay_metrics::ByNamespace">ByNamespace</a></dt><dd>Utility to store information for each <a href="enum.MetricNamespace.html" title="enum relay_metrics::MetricNamespace"><code>MetricNamespace</code></a>.</dd><dt><a class="struct" href="struct.CustomUnit.html" title="struct relay_metrics::CustomUnit">Custom<wbr>Unit</a></dt><dd>Custom user-defined units without builtin conversion.</dd><dt><a class="struct" href="struct.GaugeValue.html" title="struct relay_metrics::GaugeValue">Gauge<wbr>Value</a></dt><dd>A snapshot of values within a <a href="struct.Bucket.html" title="struct relay_metrics::Bucket"><code>Bucket</code></a>.</dd><dt><a class="struct" href="struct.MetricName.html" title="struct relay_metrics::MetricName">Metric<wbr>Name</a></dt><dd>Optimized string represenation of a metric name.</dd><dt><a class="struct" href="struct.MetricResourceIdentifier.html" title="struct relay_metrics::MetricResourceIdentifier">Metric<wbr>Resource<wbr>Identifier</a></dt><dd>A unique identifier for metrics including typing and namespacing.</dd><dt><a class="struct" href="struct.ParseBuckets.html" title="struct relay_metrics::ParseBuckets">Parse<wbr>Buckets</a></dt><dd>Iterator over parsed metrics returned from <a href="struct.Bucket.html#method.parse_all" title="associated function relay_metrics::Bucket::parse_all"><code>Bucket::parse_all</code></a>.</dd><dt><a class="struct" href="struct.ParseMetricError.html" title="struct relay_metrics::ParseMetricError">Parse<wbr>Metric<wbr>Error</a></dt><dd>An error returned when metrics or MRIs cannot be parsed.</dd><dt><a class="struct" href="struct.ParseMetricUnitError.html" title="struct relay_metrics::ParseMetricUnitError">Parse<wbr>Metric<wbr>Unit<wbr>Error</a></dt><dd>An error parsing a <a href="enum.MetricUnit.html" title="enum relay_metrics::MetricUnit"><code>MetricUnit</code></a> or one of its variants.</dd><dt><a class="struct" href="struct.SetView.html" title="struct relay_metrics::SetView">SetView</a></dt><dd>A view into the datapoints of a set metric.</dd><dt><a class="struct" href="struct.UnixTimestamp.html" title="struct relay_metrics::UnixTimestamp">Unix<wbr>Timestamp</a></dt><dd>A unix timestamp (full seconds elapsed since 1970-01-01 00:00 UTC).</dd></dl><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2><dl class="item-table"><dt><a class="enum" href="enum.BucketValue.html" title="enum relay_metrics::BucketValue">Bucket<wbr>Value</a></dt><dd>The <a href="struct.Bucket.html#structfield.value" title="field relay_metrics::Bucket::value">aggregated value</a> of a metric bucket.</dd><dt><a class="enum" href="enum.BucketViewValue.html" title="enum relay_metrics::BucketViewValue">Bucket<wbr>View<wbr>Value</a></dt><dd>A view into the datapoints of a <a href="enum.BucketValue.html" title="enum relay_metrics::BucketValue"><code>BucketValue</code></a>.</dd><dt><a class="enum" href="enum.DurationUnit.html" title="enum relay_metrics::DurationUnit">Duration<wbr>Unit</a></dt><dd>Time duration units used in <a href="enum.MetricUnit.html#variant.Duration" title="variant relay_metrics::MetricUnit::Duration"><code>MetricUnit::Duration</code></a>.</dd><dt><a class="enum" href="enum.FractionUnit.html" title="enum relay_metrics::FractionUnit">Fraction<wbr>Unit</a></dt><dd>Units of fraction used in <a href="enum.MetricUnit.html#variant.Fraction" title="variant relay_metrics::MetricUnit::Fraction"><code>MetricUnit::Fraction</code></a>.</dd><dt><a class="enum" href="enum.InformationUnit.html" title="enum relay_metrics::InformationUnit">Information<wbr>Unit</a></dt><dd>Size of information derived from bytes, used in <a href="enum.MetricUnit.html#variant.Information" title="variant relay_metrics::MetricUnit::Information"><code>MetricUnit::Information</code></a>.</dd><dt><a class="enum" href="enum.MetricNamespace.html" title="enum relay_metrics::MetricNamespace">Metric<wbr>Namespace</a></dt><dd>The namespace of a metric.</dd><dt><a class="enum" href="enum.MetricType.html" title="enum relay_metrics::MetricType">Metric<wbr>Type</a></dt><dd>The type of a <a href="struct.MetricResourceIdentifier.html" title="struct relay_metrics::MetricResourceIdentifier"><code>MetricResourceIdentifier</code></a>, determining its aggregation and evaluation.</dd><dt><a class="enum" href="enum.MetricUnit.html" title="enum relay_metrics::MetricUnit">Metric<wbr>Unit</a></dt><dd>The unit of measurement of a metric value.</dd><dt><a class="enum" href="enum.NormalizationError.html" title="enum relay_metrics::NormalizationError">Normalization<wbr>Error</a></dt><dd>Error returned from <a href="fn.normalize_bucket.html" title="fn relay_metrics::normalize_bucket"><code>normalize_bucket</code></a>.</dd><dt><a class="enum" href="enum.UnescapeError.html" title="enum relay_metrics::UnescapeError">Unescape<wbr>Error</a></dt><dd>Unescaper’s <code>Error</code>.</dd></dl><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2><dl class="item-table"><dt><a class="fn" href="fn.normalize_bucket.html" title="fn relay_metrics::normalize_bucket">normalize_<wbr>bucket</a></dt><dd>Normalizes a bucket.</dd></dl><h2 id="types" class="section-header">Type Aliases<a href="#types" class="anchor">§</a></h2><dl class="item-table"><dt><a class="type" href="type.CounterType.html" title="type relay_metrics::CounterType">Counter<wbr>Type</a></dt><dd>Type used for Counter metric</dd><dt><a class="type" href="type.DistributionType.html" title="type relay_metrics::DistributionType">Distribution<wbr>Type</a></dt><dd>Type of distribution entries</dd><dt><a class="type" href="type.DistributionValue.html" title="type relay_metrics::DistributionValue">Distribution<wbr>Value</a></dt><dd>A distribution of values within a <a href="struct.Bucket.html" title="struct relay_metrics::Bucket"><code>Bucket</code></a>.</dd><dt><a class="type" href="type.GaugeType.html" title="type relay_metrics::GaugeType">Gauge<wbr>Type</a></dt><dd>Type used for Gauge entries</dd><dt><a class="type" href="type.MetricTags.html" title="type relay_metrics::MetricTags">Metric<wbr>Tags</a></dt><dd>Type of <a href="struct.Bucket.html#structfield.tags" title="field relay_metrics::Bucket::tags"><code>Bucket::tags</code></a>.</dd><dt><a class="type" href="type.SetType.html" title="type relay_metrics::SetType">SetType</a></dt><dd>Type used for set elements in Set metric</dd><dt><a class="type" href="type.SetValue.html" title="type relay_metrics::SetValue">SetValue</a></dt><dd>A set of unique values.</dd></dl></section></div></main></body></html>