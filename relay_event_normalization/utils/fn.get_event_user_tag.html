<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Compute the transaction event’s “user” tag as close as possible to how users are determined in the transactions dataset in Snuba. This should produce the exact same user counts as the `user` column in Discover for Transactions, barring:"><title>get_event_user_tag in relay_event_normalization::utils - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-b0742ba02757f159.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="relay_event_normalization" data-themes="" data-resource-suffix="" data-rustdoc-version="1.83.0 (90b35a623 2024-11-26)" data-channel="1.83.0" data-search-js="search-f0d225181b97f9a4.js" data-settings-js="settings-805db61a62df4bd2.js" ><script src="../../static.files/storage-1d39b6787ed640ff.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../static.files/main-f070b9041d14864c.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-0111fcff984fae8f.css"></noscript><link rel="icon" href="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png"></head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button><a class="logo-container" href="../../relay_event_normalization/index.html"><img src="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png" alt=""></a></nav><nav class="sidebar"><div class="sidebar-crate"><a class="logo-container" href="../../relay_event_normalization/index.html"><img src="https://raw.githubusercontent.com/getsentry/relay/master/artwork/relay-icon.png" alt="logo"></a><h2><a href="../../relay_event_normalization/index.html">relay_<wbr>event_<wbr>normalization</a><span class="version">24.12.0</span></h2></div><div class="sidebar-elems"><div id="rustdoc-modnav"><h2><a href="index.html">In relay_<wbr>event_<wbr>normalization::<wbr>utils</a></h2></div></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><span class="rustdoc-breadcrumbs"><a href="../index.html">relay_event_normalization</a>::<wbr><a href="index.html">utils</a></span><h1>Function <span class="fn">get_event_user_tag</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../../src/relay_event_normalization/normalize/utils.rs.html#136-154">source</a> </span></div><pre class="rust item-decl"><code>pub fn get_event_user_tag(user: &amp;<a class="struct" href="../../relay_event_schema/protocol/user/struct.User.html" title="struct relay_event_schema::protocol::user::User">User</a>) -&gt; <a class="enum" href="https://doc.rust-lang.org/1.83.0/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="struct" href="https://doc.rust-lang.org/1.83.0/alloc/string/struct.String.html" title="struct alloc::string::String">String</a>&gt;</code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Compute the transaction event’s “user” tag as close as possible to how users are determined in
the transactions dataset in Snuba. This should produce the exact same user counts as the <code>user</code>
column in Discover for Transactions, barring:</p>
<ul>
<li>
<p>imprecision caused by HLL sketching in Snuba, which we don’t have in events</p>
</li>
<li>
<p>hash collisions in <code>BucketValue::set_from_display</code>, which we don’t have in events</p>
</li>
<li>
<p>MD5-collisions caused by <code>EventUser.hash_from_tag</code>, which we don’t have in metrics</p>
<p>MD5 is used to efficiently look up the current event user for an event, and if there is a
collision it seems that this code will fetch an event user with potentially different values
for everything that is in <code>defaults</code>:
<a href="https://github.com/getsentry/sentry/blob/f621cd76da3a39836f34802ba9b35133bdfbe38b/src/sentry/event_manager.py#L1058-L1060">https://github.com/getsentry/sentry/blob/f621cd76da3a39836f34802ba9b35133bdfbe38b/src/sentry/event_manager.py#L1058-L1060</a></p>
</li>
</ul>
<p>The performance product runs a discover query such as <code>count_unique(user)</code>, which maps to two
things:</p>
<ul>
<li><code>user</code> metric for the metrics dataset</li>
<li>the “promoted tag” column <code>user</code> in the transactions clickhouse table</li>
</ul>
<p>A promoted tag is a tag that snuba pulls out into its own column. In this case it pulls out the
<code>sentry:user</code> tag from the event payload:
<a href="https://github.com/getsentry/snuba/blob/430763e67e30957c89126e62127e34051eb52fd6/snuba/datasets/transactions_processor.py#L151">https://github.com/getsentry/snuba/blob/430763e67e30957c89126e62127e34051eb52fd6/snuba/datasets/transactions_processor.py#L151</a></p>
<p>Sentry’s processing pipeline defers to <code>sentry.models.EventUser</code> to produce the <code>sentry:user</code> tag
here: <a href="https://github.com/getsentry/sentry/blob/f621cd76da3a39836f34802ba9b35133bdfbe38b/src/sentry/event_manager.py#L790-L794">https://github.com/getsentry/sentry/blob/f621cd76da3a39836f34802ba9b35133bdfbe38b/src/sentry/event_manager.py#L790-L794</a></p>
<p><code>sentry.models.eventuser.KEYWORD_MAP</code> determines which attributes are looked up in which order, here:
<a href="https://github.com/getsentry/sentry/blob/f621cd76da3a39836f34802ba9b35133bdfbe38b/src/sentry/models/eventuser.py#L18">https://github.com/getsentry/sentry/blob/f621cd76da3a39836f34802ba9b35133bdfbe38b/src/sentry/models/eventuser.py#L18</a>
If its order is changed, this function needs to be changed.</p>
</div></details></section></div></main></body></html>