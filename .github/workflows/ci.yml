name: CI

on:
  push:
    branches:
      - release/**
      - release-library/**

  pull_request:
    types: [opened, synchronize, reopened, labeled]

  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RELAY_CARGO_ARGS: "--locked"
  IS_MASTER: "${{ github.event_name == 'merge_group' }}"

jobs:
  sentry-relay-integration-tests:
    name: Sentry-Relay Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      USE_NEW_DEVSERVICES: 1

    # Skip redundant checks for library releases
    if: "!startsWith(github.ref, 'refs/heads/release-library/')"

    steps:
      # Checkout Sentry and run integration tests against latest Relay
      - name: Checkout Sentry
        uses: actions/checkout@v5
        with:
          repository: getsentry/sentry
          ref: f667b72e5e8b62b819fad17775e3497fbf8aec38
          path: sentry

      - name: Setup steps
        id: setup
        run: |
          # GITHUB_SHA in pull requests points to the merge commit
          RELAY_TEST_IMAGE=ghcr.io/getsentry/relay:039dd52504583c3a8fdd516f7886252b2bd2445d
          echo "We expected GCB to push this image $RELAY_TEST_IMAGE"
          echo "relay-test-image=$RELAY_TEST_IMAGE" >> "$GITHUB_OUTPUT"
          # We cannot execute actions that are not placed under .github of the main repo
          mkdir -p .github/actions
          cp -r sentry/.github/actions/setup-sentry .github/actions/

      - name: Setup Sentry
        uses: ./.github/actions/setup-sentry
        with:
          workdir: sentry
          mode: symbolicator

      - name: Download Docker Image
        if: "github.event.pull_request.head.repo.fork || github.actor == 'dependabot[bot]'"
        uses: actions/download-artifact@v5
        with:
          name: relay-docker-image

      - name: Import Docker Image
        if: "github.event.pull_request.head.repo.fork || github.actor == 'dependabot[bot]'"
        run: docker load -i relay-docker-image

      - name: Run Sentry integration tests
        working-directory: sentry
        env:
          RELAY_TEST_IMAGE: ${{ steps.setup.outputs.relay-test-image }}
        run: |
          echo "Testing against ${RELAY_TEST_IMAGE}"
          make test-relay-integration
