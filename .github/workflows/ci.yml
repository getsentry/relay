name: CI

on:
  push:
    branches:
      - release/**
      - release-library/**

  pull_request:
    types: [opened, synchronize, reopened, labeled]

  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RELAY_CARGO_ARGS: "--locked"
  IS_MASTER: "${{ github.event_name == 'merge_group' }}"

jobs:
  build-setup:
    name: Setup build metadata
    runs-on: ubuntu-latest

    if: "!startsWith(github.ref, 'refs/heads/release-library/')"

    env:
      FULL_CI: "${{
        github.ref == 'refs/heads/master'
        || github.event_name == 'merge_group'
        || startsWith(github.ref, 'refs/heads/release/')
        || contains(github.event.pull_request.labels.*.name, 'Trigger: Full-CI')
      }}"

    steps:
      - id: set-outputs
        run: |
          echo "full_ci=$FULL_CI" >> $GITHUB_OUTPUT

          if [[ "$FULL_CI" == "true" ]]; then
            echo "Running full CI"
            echo 'image_names=["relay", "relay-pop"]' >> $GITHUB_OUTPUT
            echo 'targets=["x86_64-unknown-linux-gnu", "aarch64-unknown-linux-gnu"]' >> $GITHUB_OUTPUT
            echo 'platforms=["linux/amd64","linux/arm64"]' >> $GITHUB_OUTPUT
          else
            echo "Skipping some CI steps"
            echo 'image_names=["relay"]' >> $GITHUB_OUTPUT
            echo 'targets=["x86_64-unknown-linux-gnu"]' >> $GITHUB_OUTPUT
            echo 'platforms=["linux/amd64"]' >> $GITHUB_OUTPUT
          fi

          if [[ ("${{ github.event.pull_request.head.repo.fork }}" != "true" && "${{ github.actor }}" != "dependabot[bot]") || "${{ needs.build-setup.outputs.full_ci }}" == "true" ]]; then
            echo "rustflags=--cfg sentry --cfg tokio_unstable" >> "$GITHUB_OUTPUT"
          else
            echo "rustflags=--cfg tokio_unstable" >> "$GITHUB_OUTPUT"
          fi

    outputs:
      image_names: "${{ steps.set-outputs.outputs.image_names }}"
      targets: "${{ steps.set-outputs.outputs.targets }}"
      platforms: "${{ steps.set-outputs.outputs.platforms }}"
      full_ci: "${{ steps.set-outputs.outputs.full_ci }}"
      rustflags: "${{ steps.set-outputs.outputs.rustflags }}"

  test_integration:
    needs: build-setup
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      RUSTFLAGS:  ${{ needs.build-setup.outputs.rustflags }}
      SSH_PRIVATE_KEY:  ${{ secrets.SSH_PRIVATE_KEY }}

    # Skip redundant checks for library releases
    if: "!startsWith(github.ref, 'refs/heads/release-library/')"

    services:
      redis: # https://docs.github.com/en/actions/guides/creating-redis-service-containers
        image: ghcr.io/getsentry/image-mirror-library-redis:5.0-alpine
        ports:
          - 6379:6379

      kafka:
        image: ghcr.io/getsentry/image-mirror-confluentinc-cp-kafka:7.5.0
        env:
          # KRaft mode configuration (no Zookeeper)
          KAFKA_PROCESS_ROLES: broker,controller
          KAFKA_CONTROLLER_QUORUM_VOTERS: 1001@127.0.0.1:29093
          KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
          KAFKA_NODE_ID: 1001
          CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,EXTERNAL://0.0.0.0:9092,CONTROLLER://0.0.0.0:29093
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://127.0.0.1:29092,EXTERNAL://127.0.0.1:9092
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
          KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          KAFKA_OFFSETS_TOPIC_NUM_PARTITIONS: 1
        ports:
          - 9092:9092

    steps:
      - name: Install libcurl-dev
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev

      - name: Start objectstore
        run: |
          docker run -d \
            --name objectstore \
            -p 8888:8888 \
            ghcr.io/getsentry/objectstore:nightly \
            run

      - uses: actions/checkout@v6.0.2
        with:
          submodules: recursive

      - name: Install Rust Toolchain
        run: rustup toolchain install stable --profile minimal --no-self-update

      - uses: swatinem/rust-cache@v2
        with:
          key: ${{ github.job }}
          cache-on-failure: "true"

      - name: Setup SSH agent
        if: env.SSH_PRIVATE_KEY != ''
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.SSH_PRIVATE_KEY }}

      - uses: astral-sh/setup-uv@884ad927a57e558e7a70b92f2bccf9198a4be546 # v6
        with:
          version: '0.8.2'
          # we just cache the venv-dir directly in action-setup-venv
          enable-cache: false

      - uses: getsentry/action-setup-venv@5a80476d175edf56cb205b08bc58986fa99d1725 # v3.2.0
        with:
          cache-dependency-path: uv.lock
          install-cmd: uv sync --frozen --only-dev --active

      - run: make test-integration
        env:
          PYTEST_N: 6
          RELAY_VERSION_CHAIN: "23.12.0,latest"

