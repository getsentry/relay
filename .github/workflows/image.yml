on:
  pull_request:
  push:
    branches: [master]
jobs:
  build:
    timeout-minutes: 30
    strategy:
      matrix:
        # the arm64 build takes too long, so disable for now
        arch: [amd64]
    runs-on: ubuntu-latest
    env:
      IMG_CACHE: ghcr.io/getsentry/relay:${{ matrix.arch }}-latest
      IMG_VERSIONED: ghcr.io/getsentry/relay:${{ matrix.arch }}-${{ github.sha }}
    steps:
    - uses: actions/checkout@v3
    - run: docker run --rm --privileged tonistiigi/binfmt --install arm64
      if: matrix.arch == 'arm64'
    - name: build
      run: |
        set -euxo pipefail
        args=()
        if docker pull -q "$IMG_CACHE"; then
          args+=(--cache-from "$IMG_CACHE")
        fi
        docker buildx build \
            "${args[@]}" \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --platform linux/${{ matrix.arch }} \
            --tag "$IMG_VERSIONED" \
            .
        docker tag "$IMG_VERSIONED" "$IMG_CACHE"
    - name: push ghcr.io
      # TODO: this actually should be the same like in cloudbuild now, build and push on every commit in PR as well.
      if: github.event_name != 'pull_request'
      run: |
        set -euxo pipefail
        docker login --username '${{ github.actor }}' --password '${{ secrets.GITHUB_TOKEN }}' ghcr.io
        docker push "$IMG_VERSIONED"
        docker push "$IMG_CACHE"

        # for now arm64 is too slow so just retag this as latest
        docker tag "$IMG_VERSIONED" ghcr.io/getsentry/relay:latest
        docker push ghcr.io/getsentry/relay:latest
    - name: push gcr.io
      # TODO: this actually should be the same like in cloudbuild now, build and push on every commit in PR as well.
      if: github.event_name != 'pull_request'
      run: |
        set -euxo pipefail
        # TODO: get creadentials for pushing this
        # docker login --username '${{ github.actor }}' --password '${{ secrets.GITHUB_TOKEN }}' us.gcr.io
        docker tag "$IMG_VERSIONED" "us.gcr.io/sentryio/relay:${{ github.sha }}"
        docker push "us.gcr.io/sentryio/relay:${{ github.sha }}"
