# More information on gocd-flavor YAML can be found here:
# - https://github.com/tomzo/gocd-yaml-config-plugin#pipeline
# - https://www.notion.so/sentry/GoCD-New-Service-Quickstart-6d8db7a6964049b3b0e78b8a4b52e25d
format_version: 10
pipelines:
    deploy-relay-pop:
        environment_variables:
            GCP_PROJECT: internal-sentry
        group: relay
        lock_behavior: unlockWhenFinished
        materials:
            relay_repo:
                git: git@github.com:getsentry/relay.git
                shallow_clone: true
                branch: master
                destination: relay
            # Relay PoPs can't be deployed until the relay deploy pipeline reaches
            # the promote-to-pops stage.
            pipeline-deploy-relay-completed:
                pipeline: deploy-relay
                stage: promote-to-pops
        stages:
            # checks aren't needed because it's implied by pipeline-deploy-relay-completed.
            - deploy:
                  approval:
                      type: manual
                  fetch_materials: true
                  jobs:
                      deploy-pop-europe-1:
                          timeout: 1200
                          elastic_profile_id: relay-pop
                          environment_variables:
                              GKE_CLUSTER: pop-europe-1
                              GKE_REGION: europe-west3
                              GKE_CLUSTER_ZONE: b
                              GKE_BASTION_ZONE: b
                          tasks:
                              - script: |
                                    /devinfra/scripts/k8s/k8stunnel \
                                    && /devinfra/scripts/k8s/k8sdeploy.py \
                                    --label-selector="service=relay-pop" \
                                    --image="us.gcr.io/sentryio/relay:${GO_REVISION_RELAY_REPO}" \
                                    --container-name="relay"
                      deploy-pop-us-1:
                          timeout: 1200
                          elastic_profile_id: relay-pop
                          environment_variables:
                              GKE_CLUSTER: pop-us-1
                              GKE_REGION: us-central1
                              GKE_CLUSTER_ZONE: f
                              GKE_BASTION_ZONE: f
                          tasks:
                              - script: |
                                    /devinfra/scripts/k8s/k8stunnel \
                                    && /devinfra/scripts/k8s/k8sdeploy.py \
                                    --label-selector="service=relay-pop" \
                                    --image="us.gcr.io/sentryio/relay:${GO_REVISION_RELAY_REPO}" \
                                    --container-name="relay"
                      deploy-pop-asia-1:
                          timeout: 1200
                          elastic_profile_id: relay-pop
                          environment_variables:
                              GKE_CLUSTER: pop-asia-1
                              GKE_REGION: asia-northeast1
                              GKE_CLUSTER_ZONE: b
                              GKE_BASTION_ZONE: b
                          tasks:
                              - script: |
                                    /devinfra/scripts/k8s/k8stunnel \
                                    && /devinfra/scripts/k8s/k8sdeploy.py \
                                    --label-selector="service=relay-pop" \
                                    --image="us.gcr.io/sentryio/relay:${GO_REVISION_RELAY_REPO}" \
                                    --container-name="relay"
                      deploy-pop-australia-1:
                          timeout: 1200
                          elastic_profile_id: relay-pop
                          environment_variables:
                              GKE_CLUSTER: pop-australia-1
                              GKE_REGION: australia-southeast1
                              GKE_CLUSTER_ZONE: b
                              GKE_BASTION_ZONE: b
                          tasks:
                              - script: |
                                    /devinfra/scripts/k8s/k8stunnel \
                                    && /devinfra/scripts/k8s/k8sdeploy.py \
                                    --label-selector="service=relay-pop" \
                                    --image="us.gcr.io/sentryio/relay:${GO_REVISION_RELAY_REPO}" \
                                    --container-name="relay"
