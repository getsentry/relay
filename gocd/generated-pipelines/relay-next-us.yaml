{
   "format_version": 10,
   "pipelines": {
      "region-deploy-relay-next-us": {
         "environment_variables": {
            "SENTRY_REGION": "us"
         },
         "group": "relay-next",
         "lock_behavior": "unlockWhenFinished",
         "materials": {
            "relay_repo": {
               "branch": "master",
               "destination": "relay",
               "git": "git@github.com:getsentry/relay.git",
               "shallow_clone": true
            },
            "upstream_pipeline": {
               "pipeline": "deploy-relay-next",
               "stage": "pipeline-complete"
            }
         },
         "stages": [
            {
               "ready": {
                  "jobs": {
                     "ready": {
                        "tasks": [
                           {
                              "exec": {
                                 "command": true
                              }
                           }
                        ]
                     }
                  }
               }
            },
            {
               "wait": {
                  "approval": {
                     "type": "manual"
                  },
                  "jobs": {
                     "wait": {
                        "tasks": [
                           {
                              "exec": {
                                 "command": true
                              }
                           }
                        ]
                     }
                  }
               }
            },
            {
               "checks": {
                  "fetch_materials": true,
                  "jobs": {
                     "checks": {
                        "elastic_profile_id": "relay",
                        "environment_variables": {
                           "GITHUB_TOKEN": "{{SECRET:[devinfra-github][token]}}"
                        },
                        "tasks": [
                           {
                              "script": "##!/bin/bash\n\n/devinfra/scripts/checks/githubactions/checkruns.py \\\n    getsentry/relay \\\n    \"${GO_REVISION_RELAY_REPO}\" \\\n    \"Integration Tests\" \\\n    \"Test (macos-latest)\" \\\n    \"Test (windows-latest)\" \\\n    \"Test All Features (ubuntu-latest)\" \\\n    \"Push GCR Docker Image\"\n"
                           }
                        ],
                        "timeout": 1800
                     }
                  }
               }
            },
            {
               "deploy-production": {
                  "fetch_materials": true,
                  "jobs": {
                     "create_sentry_release": {
                        "elastic_profile_id": "relay",
                        "environment_variables": {
                           "SENTRY_AUTH_TOKEN": "{{SECRET:[devinfra-temp][relay_sentry_auth_token]}}",
                           "SENTRY_ORG": "sentry",
                           "SENTRY_PROJECT": "relay",
                           "SENTRY_URL": "https://sentry.my.sentry.io/"
                        },
                        "tasks": [
                           {
                              "script": "##!/bin/bash\n\n./relay/scripts/create-sentry-release \"${GO_REVISION_RELAY_REPO}\"\n"
                           }
                        ],
                        "timeout": 1200
                     },
                     "deploy": {
                        "elastic_profile_id": "relay",
                        "tasks": [
                           {
                              "script": "##!/bin/bash\n\neval $(/devinfra/scripts/regions/project_env_vars.py --region=\"${SENTRY_REGION}\")\n\n/devinfra/scripts/k8s/k8stunnel\n\n/devinfra/scripts/k8s/k8s-deploy.py \\\n    --label-selector=\"service=relay,deploy_if_production=true\" \\\n    --image=\"us.gcr.io/sentryio/relay:${GO_REVISION_RELAY_REPO}\" \\\n    --container-name=\"relay\"\n"
                           }
                        ],
                        "timeout": 1200
                     }
                  }
               }
            },
            {
               "deploy-pops": {
                  "fetch_materials": true,
                  "jobs": {
                     "create_sentry_release": {
                        "elastic_profile_id": "relay",
                        "environment_variables": {
                           "SENTRY_AUTH_TOKEN": "{{SECRET:[devinfra-temp][relay_sentry_auth_token]}}",
                           "SENTRY_ORG": "sentry",
                           "SENTRY_PROJECT": "pop-relay",
                           "SENTRY_URL": "https://sentry.my.sentry.io/"
                        },
                        "tasks": [
                           {
                              "script": "##!/bin/bash\n\n./relay/scripts/create-sentry-release \"${GO_REVISION_RELAY_REPO}\"\n"
                           }
                        ],
                        "timeout": 1200
                     },
                     "deploy-pops-us-pop-1": {
                        "elastic_profile_id": "relay-pop",
                        "tasks": [
                           {
                              "script": "##!/bin/bash\n\neval $(/devinfra/scripts/regions/project_env_vars.py --region=\"${SENTRY_REGION}\")\n\n/devinfra/scripts/k8s/k8stunnel\n\n/devinfra/scripts/k8s/k8s-deploy.py \\\n    --label-selector=\"service=relay-pop\" \\\n    --image=\"us.gcr.io/sentryio/relay:${GO_REVISION_RELAY_REPO}\" \\\n    --container-name=\"relay\"\n"
                           }
                        ],
                        "timeout": 1200
                     },
                     "deploy-pops-us-pop-2": {
                        "elastic_profile_id": "relay-pop",
                        "tasks": [
                           {
                              "script": "##!/bin/bash\n\neval $(/devinfra/scripts/regions/project_env_vars.py --region=\"${SENTRY_REGION}\")\n\n/devinfra/scripts/k8s/k8stunnel\n\n/devinfra/scripts/k8s/k8s-deploy.py \\\n    --label-selector=\"service=relay-pop\" \\\n    --image=\"us.gcr.io/sentryio/relay:${GO_REVISION_RELAY_REPO}\" \\\n    --container-name=\"relay\"\n"
                           }
                        ],
                        "timeout": 1200
                     },
                     "deploy-pops-us-pop-3": {
                        "elastic_profile_id": "relay-pop",
                        "tasks": [
                           {
                              "script": "##!/bin/bash\n\neval $(/devinfra/scripts/regions/project_env_vars.py --region=\"${SENTRY_REGION}\")\n\n/devinfra/scripts/k8s/k8stunnel\n\n/devinfra/scripts/k8s/k8s-deploy.py \\\n    --label-selector=\"service=relay-pop\" \\\n    --image=\"us.gcr.io/sentryio/relay:${GO_REVISION_RELAY_REPO}\" \\\n    --container-name=\"relay\"\n"
                           }
                        ],
                        "timeout": 1200
                     },
                     "deploy-pops-us-pop-4": {
                        "elastic_profile_id": "relay-pop",
                        "tasks": [
                           {
                              "script": "##!/bin/bash\n\neval $(/devinfra/scripts/regions/project_env_vars.py --region=\"${SENTRY_REGION}\")\n\n/devinfra/scripts/k8s/k8stunnel\n\n/devinfra/scripts/k8s/k8s-deploy.py \\\n    --label-selector=\"service=relay-pop\" \\\n    --image=\"us.gcr.io/sentryio/relay:${GO_REVISION_RELAY_REPO}\" \\\n    --container-name=\"relay\"\n"
                           }
                        ],
                        "timeout": 1200
                     }
                  }
               }
            },
            {
               "pipeline-complete": {
                  "approval": {
                     "allow_only_on_success": true,
                     "type": "success"
                  },
                  "jobs": {
                     "pipeline-complete": {
                        "tasks": [
                           {
                              "exec": {
                                 "command": true
                              }
                           }
                        ]
                     }
                  }
               }
            }
         ]
      }
   }
}
